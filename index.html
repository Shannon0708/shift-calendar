<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‡æ—¥è¨ˆç®—æ©Ÿ</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#101a2d; --text:#e7edf7; --muted:#a8b3c7;
      --line:rgba(255,255,255,.12); --red:#ff5a6a; --green:#42d38b; --yellow:#ffd56a;
      --blue:#6aa7ff; --purple:#c58bff; --gray:#9aa7bb; --shadow: 0 10px 28px rgba(0,0,0,.35);
      --radius:14px; --cell: 118px;

    --pageBg: radial-gradient(1200px 600px at 15% 10%, rgba(106,167,255,.22), transparent 55%),
              radial-gradient(900px 500px at 70% 10%, rgba(197,139,255,.18), transparent 55%),
              radial-gradient(900px 700px at 50% 90%, rgba(66,211,139,.12), transparent 55%),
              var(--bg);

    }
    html {
      font-size: 100%; /* åƒ Android / iOS ç³»çµ±å­—é«”å¤§å° */
    }
    *{box-sizing:border-box;}

    html, body { height: auto; overflow-x: hidden; overflow-y: auto;}
    body { padding: 24px; background: var(--pageBg); }

    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --text:#0b1220; --muted:#53607a;
      --line:rgba(0,0,0,.12); --shadow: 0 10px 28px rgba(0,0,0,.10);
      --pageBg: radial-gradient(1200px 600px at 15% 10%, rgba(106,167,255,.16), transparent 55%),
                radial-gradient(900px 500px at 70% 10%, rgba(197,139,255,.12), transparent 55%),
                radial-gradient(900px 700px at 50% 90%, rgba(66,211,139,.10), transparent 55%),
                var(--bg);
    }

    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      color: var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 1.55fr .95fr; gap:18px; min-height: 100svh;}
    @media (max-width: 1020px){ .wrap{grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; min-height: 100svh;} }
    .card{display:flex; flex-direction:column; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden;}
    .header{flex:0 0 auto; padding:16px 18px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.08);}
    .title{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;}
    /* .title h1{font-size: clamp(0.9rem, 1em, 1.05rem); margin:0;} */
    .controls,
    .controls button,
    .controls select,
    .controls input {
      font-size: clamp(0.72rem, 0.85rem, 0.9rem);
    }
    .controls select {max-width: 5.5rem;}

    .title .sub{color:var(--muted); clamp(0.7rem, 0.85em, 0.85rem);}
    .controls{display:flex; gap:6px; align-items:center; flex-wrap:wrap;  min-width: 0;} /* min-width å…è¨±å…§éƒ¨ shrink */
    .controls > * {   /*æ‰€æœ‰ controls å…è¨±è¢«å£“ç¸®*/
      min-width: 0;             /* ä¸è¨­é€™å€‹ä¸€å®šæœƒçˆ† */
      flex-shrink: 1;           /* é è¨­æ˜¯ 1ï¼Œä½†æ˜å¯«æ¯”è¼ƒå®‰å…¨ */
    }
    button, select, input[type="number"]{background: rgba(255,255,255,.06); color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 9px 10px; outline:none; cursor:pointer;}
    .year-input {
      width: clamp(4.8rem, 5.2rem, 6rem);
      font-size: inherit;          /* åƒç³»çµ±å­—é«”å¤§å° */
      padding:  0.35em 0.4em;        /* è·Ÿå­—é«”æ¯”ä¾‹èµ° */
      text-align: center;
      -webkit-text-size-adjust: 100%;
    }

    button:hover{background: rgba(255,255,255,.10);}
    .ghost{background: transparent;}
    .danger{border-color: rgba(255,90,106,.55);}
    .ok{border-color: rgba(66,211,139,.55);}
    .grid{padding: 12px 12px 16px 12px; overflow:auto; flex:1; min-height:0;}
    .dow{display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; padding: 0 6px 10px 6px; color: var(--muted); font-size: 12px;}
    .dow div{padding:6px 8px;}
    .cal{display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; padding: 0 6px;}
    .cell{min-height: var(--cell); padding: 10px 10px 8px 10px; border:1px solid var(--line); border-radius: 14px;
      background: rgba(16,26,45,.72); position:relative; transition: transform .06s ease, background .12s ease, border-color .12s ease; cursor:pointer;}
    .cell:hover{ transform: translateY(-1px); background: rgba(16,26,45,.86); }
    .cell.muted{ opacity:.45; background: rgba(16,26,45,.45); cursor:default;}
    .dateRow{display:flex; justify-content:space-between; align-items:flex-start; gap:6px;}
    .dayNum{font-size: clamp(0.8rem, 0.9em, 0.95rem); font-weight:650;}
    .badges{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
    .badge{font-size:11px; padding: 2px 8px; border-radius: 999px; border:1px solid var(--line); color: var(--muted);
      background: rgba(255,255,255,.04); white-space:nowrap;}
    .badge.red{color:#ffd1d6; border-color: rgba(255,90,106,.55); background: rgba(255,90,106,.12);}
    .badge.work{color:#d7e7ff; border-color: rgba(106,167,255,.55); background: rgba(106,167,255,.12);}
    .badge.reg{color:#ffe7bd; border-color: rgba(255,213,106,.55); background: rgba(255,213,106,.12);}
    .badge.wei{color:#c8ffe7; border-color: rgba(66,211,139,.55); background: rgba(66,211,139,.12);}
    .badge.comp{color:#f2e0ff; border-color: rgba(197,139,255,.55); background: rgba(197,139,255,.12);}
    .badge.psy{color:#e8efff; border-color: rgba(154,167,187,.55); background: rgba(154,167,187,.12);}
    .badge.sick{color:#e8efff; border-color: rgba(154,167,187,.55); background: rgba(154,167,187,.12);}
    .badge.personal{color:#e8efff; border-color: rgba(154,167,187,.55); background: rgba(154,167,187,.12);}
    
    .note{margin-top:8px; font-size: 12px; color: var(--muted); line-height: 1.35; min-height: 34px; overflow:hidden;}
    
    .cell.redDay{ border-color: rgba(255,90,106,.35); }
    .cell.today{ outline: 2px solid rgba(106,167,255,.55); outline-offset: 2px; }
    .side{padding:16px 18px 18px 18px; overflow:auto; flex:1; min-height:0;}
    .stats{display:grid; gap:10px; margin-top: 10px;}
    .stat{background: rgba(0,0,0,.12); border: 1px solid var(--line); border-radius: 14px; padding: 12px 12px;}
    .stat h3{margin:0 0 6px 0; font-size:13px; color: var(--muted); font-weight:600;}
    .stat .big{font-size: clamp(1.1rem, 1.3em, 1.4rem); font-weight:750; margin: 2px 0 0 0;}
    .stat .row{display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; color: var(--muted); font-size: 12px;}
    .pill{padding: 4px 10px; border-radius: 999px; border: 1px solid var(--line); background: rgba(255,255,255,.04);}
    .pill.ok{border-color: rgba(66,211,139,.55); color: #c8ffe7; background: rgba(66,211,139,.10);}
    .pill.warn{border-color: rgba(255,213,106,.55); color: #ffe7bd; background: rgba(255,213,106,.10);}
    .pill.bad{border-color: rgba(255,90,106,.55); color: #ffd1d6; background: rgba(255,90,106,.10);}
    .legend{margin-top: 14px; display:grid; gap:8px; color: var(--muted); font-size: 12px;}
    .legend .item{display:flex; align-items:center; gap:8px;}
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.red{background: var(--red);}
    .dot.work{background: var(--blue);}
    .dot.reg{background: var(--yellow);}
    .dot.wei{background: var(--green);}
    .dot.comp{background: var(--purple);}
    .dot.psy{background: var(--gray);}
    .hr{height:1px; background: var(--line); margin: 12px 0;}
    .small{font-size:12px; color: var(--muted); line-height:1.4;}
    .row2{display:flex; gap:8px; flex-wrap:wrap;}
    textarea{width:100%; min-height:120px; padding:10px; background: rgba(255,255,255,.04); color: var(--text);
      border:1px solid var(--line); border-radius: 12px; outline:none; resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px;}
    .modalBack{position:fixed; inset:0; background: rgba(0,0,0,.58); display:none; align-items:center; justify-content:center;
      padding: 18px; z-index:999;}
    .modal{width:min(560px, 100%); background: rgba(16,26,45,.96); border:1px solid var(--line); border-radius: 16px; box-shadow: var(--shadow); overflow:hidden;}
    .modal .mHead{padding: 14px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); background: rgba(0,0,0,.12);}
    .modal .mHead .mTitle{font-weight:750;}
    .modal .mBody{padding: 14px 16px 16px 16px; display:grid; gap:10px;}
    .field{display:grid; gap:6px;}
    .field label{font-size:12px; color: var(--muted);}
    .field select, .field input{width:100%;}
    .modal .mActions{padding: 12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid var(--line); background: rgba(0,0,0,.10);}
  
/* ===== Calendar layout fixes ===== */
.cal {
  grid-template-columns: repeat(7, minmax(0, 1fr)); /* force 7 equal columns */
}

.cell {
  min-width: 0;            /* prevent overflow causing horizontal scroll */
  word-break: break-word;  /* allow text wrap */
}

.dow {
  grid-template-columns: repeat(7, minmax(0, 1fr));
}

/* Prevent horizontal scroll on small screens */
.cal, .dow {
  overflow-x: hidden;
}
/* ===============================
   Google Calendar MODE
   ä¸ŠåŠæœˆæ›† / ä¸‹åŠçµ±è¨ˆ
   =============================== */
body[data-mode="google"] {
   /* é—œéµï¼šæ•´é«”å­—é«” scaleï¼ˆåƒç³»çµ±è¨­å®šï¼‰ */
  font-size: 0.9em; /* ç›¸å°æ–¼ html */
}

body[data-mode="google"] .badges {
  justify-content: center;
  margin-top: 2px;
}


body[data-mode="google"] .cell {
  padding: 2px 2px;
}

body[data-mode="google"] .controls {
  flex-wrap: nowrap;
}

body[data-mode="google"] .controls * {
  font-size: clamp(0.7rem, 0.82rem, 0.88rem);
}

/* ä¸ŠåŠï¼šæœˆæ›† */
body[data-mode="google"] .card:first-child {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
}

/* ä¸‹åŠï¼šçµ±è¨ˆ */
body[data-mode="google"] .card:last-child {
  flex: 1 1 auto;
  overflow-y: auto;
}

/* ç°¡åŒ– cell é¡¯ç¤º */
body[data-mode="google"] .badge,
body[data-mode="google"] .note ,
body[data-mode="google"] .header .sub {
  display: none !important;
}

body[data-mode="google"] .dot {
  display: inline-block !important;
  width: 6px;
  height: 6px;
}

body[data-mode="google"] .dateRow {
  flex-direction: column;
  align-items: center;
}

body[data-mode="google"] .grid {
  overflow: visible;
}

body[data-mode="google"] .wrap {
  grid-template-columns: 1fr;
  grid-template-rows: auto 1fr;
  height: auto;
  min-height: 100svh;
  display: flex;
  flex-direction: column;
}

/* ===============================
  DEFAULT (Desktop / non-google)
   =============================== */
body:not([data-mode="google"]) .badge {
  display: inline-flex;
  white-space: normal;
  line-height: 1.2;
}

body:not([data-mode="google"]) .badges {
  justify-content: flex-start;
  max-width: 100%;
}


/* Desktopï¼šå…è¨±æ›è¡Œ */
body:not([data-mode="google"]) .controls {
  flex-wrap: wrap;
}

body:not([data-mode="google"]) .dot {
  display: none;
}

</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">
          <h1 id="pageTitle">æ’ç­æœˆæ›†</h1>
          <!-- <div class="sub" id="pageSub">
            è¦‹ç´…ä¼‘ä¾†æºï¼šæ”¿åºœ 115 å¹´è¡Œäº‹æ›† CSVã€‚æ”¯æ´ï¼šé»æ—¥æœŸæ”¹å‡åˆ¥ï¼›çµ±è¨ˆè£œå‡ / æ…°ä¼‘ / å¿ƒç†èª¿é©å‡ã€‚
          </div> -->
        </div>
        <div class="controls">
          <button id="prevBtn" class="ghost">â†</button>
          <select id="monthSel"></select>
          <input id="yearInp" type="number" min="1970" max="2100" class="year-input">

          <button id="nextBtn" class="ghost">â†’</button>
          <button id="themeBtn" class="ghost">åˆ‡æ›æ¨¡å¼</button>
          <button id="todayBtn">å›åˆ°ä»Šå¤©</button>
        </div>
      </div>

      <div class="grid">
        <div class="dow">
          <div>é€±ä¸€</div><div>é€±äºŒ</div><div>é€±ä¸‰</div><div>é€±å››</div><div>é€±äº”</div>
          <div style="color:#ffd1d6;">é€±å…­</div><div style="color:#ffd1d6;">é€±æ—¥</div>
        </div>
        <div class="cal" id="cal"></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <div class="title">
          <h1>çµ±è¨ˆèˆ‡è¨­å®š</h1>
          <div class="sub" id="scopeText"></div>
        </div>
      </div>
      <div class="side">
        <div class="row2">
          <button id="resetMonthBtn" class="danger">æ¸…é™¤æ­¤æœˆç´€éŒ„</button>
          <button id="resetAllBtn" class="danger">æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button>
        </div>

        <div class="hr"></div>

        <div class="stat">
          <h3>æ”¿åºœè¡Œäº‹æ›†è³‡æ–™</h3>
          <div class="small" id="govStatus">è¼‰å…¥ä¸­â€¦</div>
          <div class="row2" style="margin-top:10px;">
            <button id="reloadGovBtn">é‡è¼‰æ”¿åºœ JSON</button>
            <button id="importGovBtn" class="ghost">åŒ¯å…¥æ”¿åºœ JSONï¼ˆé¸æª”ï¼‰</button>
            <input id="govFileInp" type="file" accept="application/json" style="display:none;" />
          </div>
          <div class="small" style="margin-top:8px;">
            æ‰‹æ©Ÿè‹¥ç”¨ã€Œç›´æ¥é–‹æª”ã€(file://)ï¼Œfetch å¯èƒ½è¢«ç€è¦½å™¨é™åˆ¶ï¼›æ­¤é å·²å…§å»º 115 å¹´ JSON ä½œç‚ºå‚™æ´ï¼Œä¹Ÿå¯ç”¨ã€Œé¸æª”åŒ¯å…¥ã€ã€‚
          </div>
        </div>

        <div class="stat">
          <h3>ä¿®è­·çé‡‘</h3>
          <div class="big" id="workDayBig">â€”</div>
          <div class="row">
            <div class="pill" id="requiredWorkPill">æ‡‰ä¸Šç­ï¼šâ€”</div>
            <div class="pill" id="actualWorkPill">å¯¦éš›ä¸Šç­ï¼šâ€”</div>
            <div class="pill" id="thresholdWorkPill">é–€æª»ï¼šâ€”</div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <h3>æ…°ä¼‘ï¼ˆå›ºå®š 21 å¤©ï¼‰</h3>
            <div class="big" id="weiBig">â€”</div>
            <div class="row">
              <div class="pill" id="weiUsedPill">å·²ç”¨ï¼šâ€”</div>
              <div class="pill ok" id="weiLeftPill">å‰©é¤˜ï¼šâ€”</div>
            </div>
          </div>

          <div class="stat">
            <h3>å¿ƒç†èª¿é©å‡ï¼ˆæ¯å¹´è‡ªå‹•æ›´æ–° 3 å¤©ï¼‰</h3>
            <div class="big" id="psyBig">â€”</div>
            <div class="row">
              <div class="pill" id="psyUsedPill">å·²ç”¨ï¼šâ€”</div>
              <div class="pill ok" id="psyLeftPill">å‰©é¤˜ï¼šâ€”</div>
            </div>
            <div class="small" style="margin-top:8px;">
              è¦å‰‡ï¼šä»¥ã€Œå¹´ä»½ã€ç‚ºå–®ä½ï¼Œè©²å¹´å¿ƒç†èª¿é©å‡é¡åº¦å›ºå®š 3 å¤©ï¼›åˆ‡æ›å¹´ä»½æœƒè‡ªå‹•æ›ç®—ã€‚
            </div>
          </div>

          <div class="stat">
            <h3>è£œå‡ï¼ˆè¦‹ç´…ä¼‘å‡ºå‹¤ç´¯ç©ï¼›è£œå‡ä½¿ç”¨æ‰£é™¤ï¼‰</h3>
            <div class="big" id="compBig">â€”</div>
            <div class="row">
              <div class="pill" id="compEarnPill">ç´¯ç©é¡åº¦ï¼šâ€”</div>
              <div class="pill" id="compUsedPill">å·²ç”¨ï¼šâ€”</div>
              <div class="pill" id="compOwePill">å°šæœ‰ï¼šâ€”</div>
            </div>
            <div class="small" style="margin-top:8px;">
              è¨ˆç®—æ–¹å¼ï¼š<br/>
              1) æ”¿åºœå…¬å‘Šä¾‹å‡æ—¥è‹¥æ”¹æˆã€Œä¸Šç­ã€â†’ è¦–ç‚ºä¾‹å‡å‡ºå‹¤ï¼Œè£œå‡é¡åº¦ +1ã€‚<br/>
              2) æ¨™æˆã€Œè£œå‡ã€â†’ è¦–ç‚ºä½¿ç”¨ 1 å¤©è£œå‡ã€‚<br/>
              3) ã€Œå°šæœ‰ = ç´¯ç©é¡åº¦ - å·²ç”¨ã€ã€‚è‹¥ç‚ºè² æ•¸ï¼Œä»£è¡¨ä½ å…ˆå€Ÿç”¨è£œå‡ï¼ˆéœ€äººå·¥å°å¸³ï¼‰ã€‚
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="legend">
          <div class="item"><span class="dot red"></span>è¦‹ç´…ä¼‘ï¼ˆæ”¿åºœè¡Œäº‹æ›†ï¼‰</div>
          <div class="item"><span class="dot work"></span>ä¸Šç­</div>
          <div class="item"><span class="dot reg"></span>ä¾‹å‡</div>
          <div class="item"><span class="dot wei"></span>æ…°ä¼‘</div>
          <div class="item"><span class="dot comp"></span>è£œå‡</div>
          <div class="item"><span class="dot psy"></span>å¿ƒç†èª¿é©å‡</div>
        </div>

        <div class="hr"></div>

        <div class="small">
          å‚™ä»½/ç§»è½‰ï¼šå¯åŒ¯å‡º JSONï¼Œæˆ–è²¼ä¸Š JSON åŒ¯å…¥ã€‚<br/>
          æ³¨æ„ï¼šæœ¬é åªç”¨ç€è¦½å™¨å„²å­˜ï¼ˆlocalStorageï¼‰ï¼Œæ²’æœ‰ä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
        </div>

        <div style="margin-top:10px;" class="row2">
          <button id="exportBtn">åŒ¯å‡ºç´€éŒ„ JSON</button>
          <button id="importBtn">åŒ¯å…¥ç´€éŒ„ JSON</button>
        </div>
        <textarea id="jsonBox" placeholder="åŒ¯å‡ºå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼›æˆ–æŠŠ JSON è²¼åœ¨é€™è£¡å†æŒ‰ã€ŒåŒ¯å…¥ç´€éŒ„ JSONã€ã€‚"></textarea>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">â€”</div>
        <button id="closeModal" class="ghost">é—œé–‰</button>
      </div>
      <div class="mBody">
        <div class="field">
          <label>ä¾‹å‡æ—¥</label>
          <div id="mIsRed" class="small">â€”</div>
        </div>
        <div class="field">
          <label>ç‹€æ…‹ï¼ˆé»æ­¤æ”¹å‡åˆ¥ï¼‰</label>
          <select id="statusSel"></select>
        </div>
        <div class="field">
          <label>å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰</label>
          <input id="noteInp" type="text" placeholder="ä¾‹å¦‚ï¼šè£œå‡å°šæœªæ ¸ç™¼ã€å…ˆæ”¾æ…°ä¼‘ã€æ›ç­â€¦" />
        </div>
        <div class="small" id="mHint">â€”</div>
      </div>
      <div class="mActions">
        <button id="clearDayBtn" class="danger">æ¸…é™¤æ­¤æ—¥è¨­å®š</button>
        <button id="saveDayBtn" class="ok">å„²å­˜</button>
      </div>
    </div>
  </div>

<script>

  
(() => {
  // ====== Gov calendar JSON (115) inline fallback ======
  // ç›®çš„ï¼šæ‰‹æ©Ÿç”¨ file:// ç›´æ¥é–‹æª”æ™‚ï¼Œfetch å¯èƒ½è¢«ç€è¦½å™¨å°é–ï¼›é€™ä»½å…§å»ºè³‡æ–™å¯ç¢ºä¿ã€Œè¦‹ç´…ä¼‘ã€ä»ç„¶æ­£ç¢ºã€‚
  const GOV_CALENDAR_INLINE = {"meta": {"year": 2026, "rocYear": 115, "source": "è¡Œæ”¿é™¢äººäº‹è¡Œæ”¿ç¸½è™•", "dataset": "æ”¿åºœè¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨ï¼ˆGoogle è¡Œäº‹æ›† CSVï¼‰", "generatedAt": "2026-01-16", "timezone": "Asia/Taipei"}, "days": {"2026-01-01": {"isHoliday": true, "name": "ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥", "type": "NATIONAL_HOLIDAY"}, "2026-01-03": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-04": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-10": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-11": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-17": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-18": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-24": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-25": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-01-31": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-01": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-07": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-08": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-14": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-15": {"isHoliday": true, "name": "å°å¹´å¤œ", "type": "NATIONAL_HOLIDAY"}, "2026-02-16": {"isHoliday": true, "name": "è¾²æ›†é™¤å¤•", "type": "NATIONAL_HOLIDAY"}, "2026-02-17": {"isHoliday": true, "name": "æ˜¥ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-02-18": {"isHoliday": true, "name": "æ˜¥ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-02-19": {"isHoliday": true, "name": "æ˜¥ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-02-20": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-02-21": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-22": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-02-27": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-02-28": {"isHoliday": true, "name": "å’Œå¹³ç´€å¿µæ—¥", "type": "NATIONAL_HOLIDAY"}, "2026-03-01": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-07": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-08": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-14": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-15": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-21": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-22": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-28": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-03-29": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-03": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-04-04": {"isHoliday": true, "name": "å…’ç«¥ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-04-05": {"isHoliday": true, "name": "æ¸…æ˜ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-04-06": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-04-11": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-12": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-18": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-19": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-25": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-04-26": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-01": {"isHoliday": true, "name": "å‹å‹•ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-05-02": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-03": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-09": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-10": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-16": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-17": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-23": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-24": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-30": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-05-31": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-06": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-07": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-13": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-14": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-19": {"isHoliday": true, "name": "ç«¯åˆç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-06-20": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-21": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-27": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-06-28": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-04": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-05": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-11": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-12": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-18": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-19": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-25": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-07-26": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-01": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-02": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-08": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-09": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-15": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-16": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-22": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-23": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-29": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-08-30": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-05": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-06": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-12": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-13": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-19": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-20": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-25": {"isHoliday": true, "name": "ä¸­ç§‹ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-09-26": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-27": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-09-28": {"isHoliday": true, "name": "æ•™å¸«ç¯€", "type": "NATIONAL_HOLIDAY"}, "2026-10-03": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-04": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-09": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-10-10": {"isHoliday": true, "name": "åœ‹æ…¶æ—¥", "type": "NATIONAL_HOLIDAY"}, "2026-10-11": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-17": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-18": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-24": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-10-25": {"isHoliday": true, "name": "è‡ºç£å…‰å¾©æš¨é‡‘é–€å¤å¯§é ­å¤§æ·ç´€å¿µæ—¥", "type": "NATIONAL_HOLIDAY"}, "2026-10-26": {"isHoliday": true, "name": "è£œå‡", "type": "COMPENSATORY_HOLIDAY"}, "2026-10-31": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-01": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-07": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-08": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-14": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-15": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-21": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-22": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-28": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-11-29": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-05": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-06": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-12": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-13": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-19": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-20": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-25": {"isHoliday": true, "name": "è¡Œæ†²ç´€å¿µæ—¥", "type": "NATIONAL_HOLIDAY"}, "2026-12-26": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}, "2026-12-27": {"isHoliday": true, "name": "ä¾‹å‡æ—¥", "type": "WEEKEND"}}};

  // ä½ ä¹Ÿå¯ä»¥æŠŠ gov-calendar-115.json æ”¾åœ¨åŒè³‡æ–™å¤¾ï¼Œé é¢æœƒå„ªå…ˆå˜—è©¦ fetch å¤–éƒ¨æª”æ¡ˆä»¥åˆ©æ›´æ–°ã€‚
  const GOV_JSON_URL = "./gov-calendar-115.json";

  // ====== Config ======
  const WEI_TOTAL = 21;
  const PSY_TOTAL_PER_YEAR = 3;

  // ä½ è¦æ±‚çš„ 9/3 è»äººç¯€ï¼ˆå¦‚æœæ”¿åºœè¡Œäº‹æ›†æœªåˆ—ç‚ºæ”¾å‡ï¼Œå¯åœ¨æ­¤åŠ ç‚ºã€Œè‡ªè¨‚ç´…å­—ã€ï¼‰
  const CUSTOM_HOLIDAYS = {
    // "YYYY-MM-DD": "åç¨±"
    "2026-09-03": "è»äººç¯€"
  };

  const STATUS = {
    WORK: "WORK",
    REGULAR_OFF: "REGULAR_OFF",
    WEI: "WEI",
    COMP: "COMP",
    PSY: "PSY",
    SICK: "SICK",
    PERSONAL: "PERSONAL"
  };

  const STATUS_META = {
    [STATUS.WORK]:        { label: "ä¸Šç­", className: "work" },
    [STATUS.REGULAR_OFF]: { label: "ä¾‹å‡", className: "reg" },
    [STATUS.WEI]:         { label: "æ…°ä¼‘", className: "wei" },
    [STATUS.COMP]:        { label: "è£œå‡", className: "comp" },
    [STATUS.PSY]:         { label: "å¿ƒç†èª¿é©å‡", className: "psy" },
    [STATUS.SICK]:        { label: "ç—…å‡", className: "sick" },
    [STATUS.PERSONAL]:    { label: "äº‹å‡", className: "personal"}
  };

  // ====== Storage ======
  const STORE_KEY = "shiftCalendar.v2";           // ä½¿ç”¨ç´€éŒ„
  const GOV_STORE_KEY = "govCalendar.cache.v1";   // æ”¿åºœè¡Œäº‹æ›†å¿«å–ï¼ˆå¯è®“ä½ åŒ¯å…¥å…¶ä»–å¹´ä»½ï¼‰

  const loadAll = () => {
    try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
    catch { return {}; }
  };
  const saveAll = (obj) => localStorage.setItem(STORE_KEY, JSON.stringify(obj));

  const loadGovCache = () => {
    try { return JSON.parse(localStorage.getItem(GOV_STORE_KEY) || "null"); }
    catch { return null; }
  };
  const saveGovCache = (obj) => localStorage.setItem(GOV_STORE_KEY, JSON.stringify(obj));


  // ====== Theme (Dark/Light) ======
  const THEME_KEY = "shiftCalendar.theme";
  const themeBtn = document.getElementById("themeBtn");

  function applyTheme(theme) {
    const t = (theme === "light") ? "light" : "dark";
    document.documentElement.dataset.theme = t;
    if (themeBtn) themeBtn.textContent = (t === "light") ? "æ·±å¤œæ¨¡å¼" : "æ—¥é–“æ¨¡å¼";
  }

  function initTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) {
      applyTheme(saved);
      return;
    }
    // Default: follow system preference
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    applyTheme(prefersLight ? "light" : "dark");
  }

  if (themeBtn) {
    themeBtn.addEventListener("click", () => {
      const current = document.documentElement.dataset.theme || "dark";
      const next = (current === "light") ? "dark" : "light";
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });
  }


  // ====== Date helpers ======
  const pad2 = (n) => String(n).padStart(2, "0");
  const keyOf = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`; // m: 1-12
  const parseKey = (k) => {
    const [y,mm,dd] = k.split("-").map(Number);
    return {y, m:mm, d:dd};
  };

  // ====== Workday Calculations ======
  function computeMonthlyRequiredWorkDays(year, month) {
    const last = new Date(year, month, 0);
    const daysInMonth = last.getDate();
    let required = 0;

    for(let d = 1; d <= daysInMonth; d++) {
      if(!isRedDay(year, month, d)) {
        required++;
      }
    }
    return required;
  }

  
  // ===== Actual Working daysï¼ˆç”± baseline + ä½¿ç”¨è€…èª¿æ•´ï¼‰=====
  function computeActualWorkDays(year, month, requiredWorkDays) {
    let actual = requiredWorkDays;
    const last = new Date(year, month, 0);
    const daysInMonth = last.getDate();

    for (let d = 1; d <= daysInMonth; d++) {
      const entry = store[keyOf(year, month, d)];
      if (!entry || !entry.status) continue;

      const isRed = isRedDay(year, month, d);

      // å¹³æ—¥è«‹å‡ â†’ -1
      if (!isRed && entry.status !== STATUS.WORK) {
        actual--;
      }

      // ç´…å­—ä¸Šç­ â†’ +1
      if (isRed && entry.status === STATUS.WORK) {
        actual++;
      }
    }

    return actual;
  }

  // ===== ä¿®è­·çé‡‘é–€æª»ï¼ˆ60% ç„¡æ¢ä»¶é€²ä½ï¼‰=====
  function computeMaintenanceBonusThreshold(requiredWorkDays) {
    return Math.ceil(requiredWorkDays * 0.6);
  }

  const isSameDay = (a,b) =>
    a.getFullYear()===b.getFullYear() &&
    a.getMonth()===b.getMonth() &&
    a.getDate()===b.getDate();

  // ====== UI refs ======
  const calEl = document.getElementById("cal");
  const monthSel = document.getElementById("monthSel");
  const yearInp = document.getElementById("yearInp");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const todayBtn = document.getElementById("todayBtn");
  const scopeText = document.getElementById("scopeText");

  const resetMonthBtn = document.getElementById("resetMonthBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");

  const weiBig = document.getElementById("weiBig");
  const weiUsedPill = document.getElementById("weiUsedPill");
  const weiLeftPill = document.getElementById("weiLeftPill");

  const psyBig = document.getElementById("psyBig");
  const psyUsedPill = document.getElementById("psyUsedPill");
  const psyLeftPill = document.getElementById("psyLeftPill");

  const compBig = document.getElementById("compBig");
  const compEarnPill = document.getElementById("compEarnPill");
  const compUsedPill = document.getElementById("compUsedPill");
  const compOwePill = document.getElementById("compOwePill");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const jsonBox = document.getElementById("jsonBox");

  const govStatus = document.getElementById("govStatus");
  const reloadGovBtn = document.getElementById("reloadGovBtn");
  const importGovBtn = document.getElementById("importGovBtn");
  const govFileInp = document.getElementById("govFileInp");

  // Modal
  const modalBack = document.getElementById("modalBack");
  const closeModal = document.getElementById("closeModal");
  const mTitle = document.getElementById("mTitle");
  const mIsRed = document.getElementById("mIsRed");
  const statusSel = document.getElementById("statusSel");
  const noteInp = document.getElementById("noteInp");
  const mHint = document.getElementById("mHint");
  const clearDayBtn = document.getElementById("clearDayBtn");
  const saveDayBtn = document.getElementById("saveDayBtn");

  // ====== State ======
  let uiMode = "desktop";

  function detectUIMode() {
    return window.innerWidth <= 480 ? "google" : "desktop";
  }

  function syncUIMode() {
    const nextMode = detectUIMode();
    if (document.body.dataset.mode !== nextMode) {
      document.body.dataset.mode = nextMode;
    }
  }


  const now = new Date();
  let viewYear = now.getFullYear();
  let viewMonth = now.getMonth()+1;
  let store = loadAll();

  // æ”¿åºœè¡Œäº‹æ›†ï¼ˆæœƒå…ˆå˜—è©¦ï¼šlocalStorage cache -> fetch -> inlineï¼‰
  let govCalendar = null;

  // ====== Init selects ======
  const monthNames = ["1 æœˆ","2 æœˆ","3 æœˆ","4 æœˆ","5 æœˆ","6 æœˆ","7 æœˆ","8 æœˆ","9 æœˆ","10 æœˆ","11 æœˆ","12 æœˆ"];
  monthNames.forEach((t,i)=>{
    const opt=document.createElement("option");
    opt.value = String(i+1);
    opt.textContent = t;
    monthSel.appendChild(opt);
  });
  Object.entries(STATUS_META).forEach(([k,v])=>{
    const opt=document.createElement("option");
    opt.value = k;
    opt.textContent = v.label;
    statusSel.appendChild(opt);
  });

  // ====== Gov calendar loading ======
  function getGovDay(dateStr) {
    // è‡ªè¨‚ç´…å­—ï¼ˆå„ªå…ˆï¼‰
    if (CUSTOM_HOLIDAYS[dateStr]) {
      return { isHoliday:true, name:CUSTOM_HOLIDAYS[dateStr], type:"CUSTOM_HOLIDAY" };
    }
    return govCalendar?.days?.[dateStr] || null;
  }

  function isRedDay(y,m,d) {
    const dateStr = keyOf(y,m,d);
    const govDay = getGovDay(dateStr);
    // è‹¥ gov æœ‰è³‡æ–™ï¼ˆæˆ–è‡ªè¨‚ç´…å­—ï¼‰ï¼Œä»¥å®ƒç‚ºæº–ï¼›å¦å‰‡è¦–ç‚ºéç´…å­—ï¼ˆé¿å…è£œç­é€±å…­è¢«èª¤åˆ¤ï¼‰
    return govDay ? (govDay.isHoliday === true) : false;
  }

  function redDayLabel(y,m,d) {
    const dateStr = keyOf(y,m,d);
    const govDay = getGovDay(dateStr);
    return govDay ? govDay.name : "";
  }

  async function loadGovCalendar() {
    // 1) localStorage cache
    const cached = loadGovCache();
    if (cached?.days) {
      govCalendar = cached;
      govStatus.textContent = `å·²è¼‰å…¥ï¼ˆå¿«å–ï¼‰ï¼š${cached.meta?.rocYear ?? "?"} å¹´ï½œå…± ${Object.keys(cached.days).length} å¤©`;
      return;
    }

    // 2) try fetch external json (for easier updating)
    try {
      const res = await fetch(GOV_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data?.days) throw new Error("JSON æ ¼å¼ä¸æ­£ç¢ºï¼šç¼ºå°‘ days");
      govCalendar = data;
      saveGovCache(data);
      govStatus.textContent = `å·²è¼‰å…¥ï¼ˆæª”æ¡ˆï¼‰ï¼š${data.meta?.rocYear ?? "?"} å¹´ï½œå…± ${Object.keys(data.days).length} å¤©`;
      return;
    } catch (err) {
      // 3) fallback inline
      govCalendar = GOV_CALENDAR_INLINE;
      govStatus.textContent = `å·²è¼‰å…¥ï¼ˆå…§å»ºå‚™æ´ï¼‰ï¼š115 å¹´ï½œå…± ${Object.keys(govCalendar.days).length} å¤©ï¼ˆåŸå› ï¼šç„¡æ³•è®€å–å¤–éƒ¨ JSONï¼‰`;
    }
  }

  function importGovJsonObject(obj) {
    if (!obj || typeof obj !== "object" || !obj.days) {
      alert("æ”¿åºœ JSON æ ¼å¼ä¸æ­£ç¢ºï¼šå¿…é ˆåŒ…å« days æ¬„ä½");
      return;
    }
    govCalendar = obj;
    saveGovCache(obj);
    govStatus.textContent = `å·²è¼‰å…¥ï¼ˆåŒ¯å…¥ï¼‰ï¼š${obj.meta?.rocYear ?? "?"} å¹´ï½œå…± ${Object.keys(obj.days).length} å¤©`;
    render();
  }

  reloadGovBtn.addEventListener("click", async ()=>{
    // clear cache then reload
    localStorage.removeItem(GOV_STORE_KEY);
    govStatus.textContent = "é‡æ–°è¼‰å…¥ä¸­â€¦";
    await loadGovCalendar();
    render();
  });

  importGovBtn.addEventListener("click", ()=> govFileInp.click());
  govFileInp.addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const obj = JSON.parse(text);
      importGovJsonObject(obj);
    } catch (err) {
      alert("åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
    } finally {
      govFileInp.value = "";
    }
  });

  // ====== Core logic: day status ======
  const getDayEntry = (y,m,d) => store[keyOf(y,m,d)] || null;

  // é è¨­ä¸Šç­æ—¥ä¸Šç­ç´…å­—ä¾‹å‡æ—¥ï¼Œä½†ä½ å¯æ‰‹å‹•æ”¹æˆä¾‹å‡/æ…°ä¼‘/è£œå‡/å¿ƒç†èª¿é©å‡
  const getDayStatus = (y,m,d) => {
    const e = getDayEntry(y,m,d);
    if (e?.status) {
      return e.status;
    }

    if (isRedDay(y,m,d)) {
      return STATUS.REGULAR_OFF; // åœ¨ json è£¡ï¼Œä½†æ²’æ¨™ status â†’ ä¾‹å‡æ—¥
    }

    return STATUS.WORK; // ä¸åœ¨ json è£¡ â†’ ä¸Šç­æ—¥
  };
  const getDayNote = (y,m,d) => {
    const e = getDayEntry(y,m,d);
    return (e && e.note) ? e.note : "";
  };

  function renderDayCell({ y, m, d }) {
    const cell = document.createElement("div");
    cell.className = "cell";

    const red = isRedDay(y, m, d);
    if (red) cell.classList.add("redDay");
    if (isSameDay(new Date(y, m - 1, d), now)) cell.classList.add("today");

    const st = getDayStatus(y, m, d);
    const note = getDayNote(y, m, d);

    /* ===== date row ===== */
    const row = document.createElement("div");
    row.className = "dateRow";

    const dayNum = document.createElement("div");
    dayNum.className = "dayNum";
    dayNum.textContent = String(d);

    const badges = document.createElement("div");
    badges.className = "badges";

    /* ===== æ°¸é ç”Ÿ badgeï¼ˆæ–‡å­—ï¼‰===== */
    if (red) {
      const redBadge = document.createElement("span");
      redBadge.className = "badge red";
      redBadge.textContent = redDayLabel(y, m, d) || "ç´…å­—";
      badges.appendChild(redBadge);
    }

    const statusBadge = document.createElement("span");
    statusBadge.className = "badge " + (STATUS_META[st]?.className || "");
    statusBadge.textContent = STATUS_META[st]?.label || st;
    badges.appendChild(statusBadge);

    /* ===== æ°¸é ç”Ÿ dotï¼ˆé¡è‰²ï¼‰===== */
    const dot = document.createElement("span");
    dot.className = "dot";

    if (red && st === STATUS.WORK) {
      dot.classList.add("comp"); // ä¾‹å‡æ—¥ç•™å®ˆ
    } else if (red) {
      dot.classList.add("reg");
    } else if (st === STATUS.WEI) {
      dot.classList.add("wei");
    } else if (st === STATUS.COMP) {
      dot.classList.add("comp");
    } else if (st === STATUS.PSY) {
      dot.classList.add("psy");
    } else {
      dot.classList.add("work");
    }

    badges.appendChild(dot);

    row.appendChild(dayNum);
    row.appendChild(badges);

    /* ===== note ===== */
    const noteEl = document.createElement("div");
    noteEl.className = "note";
    noteEl.textContent = note || " ";

    cell.appendChild(row);
    cell.appendChild(noteEl);

    cell.addEventListener("click", () => openEditModal(y, m, d));

    return cell;
  }


  // ====== Rendering ======
  function render() {
    monthSel.value = String(viewMonth);
    yearInp.value = String(viewYear);
    scopeText.textContent =
      `çµ±è¨ˆç¯„åœï¼š${viewYear} å¹´ï¼ˆå¿ƒç†èª¿é©å‡ä»¥å¹´ä»½è¨ˆï¼›æ…°ä¼‘/è£œå‡ç‚ºå…¨éƒ¨è³‡æ–™ç´¯ç©ï¼‰`;

    calEl.innerHTML = "";

    const first = new Date(viewYear, viewMonth - 1, 1);
    const last = new Date(viewYear, viewMonth, 0);
    const daysInMonth = last.getDate();

    const firstDow = (first.getDay() + 6) % 7; // Monday-first
    const totalCells = Math.ceil((firstDow + daysInMonth) / 7) * 7;

    for (let i = 0; i < totalCells; i++) {
      const dayNum = i - firstDow + 1;

      if (dayNum < 1 || dayNum > daysInMonth) {
        const empty = document.createElement("div");
        empty.className = "cell muted";
        calEl.appendChild(empty);
        continue;
      }

      const cell = renderDayCell({
        y: viewYear,
        m: viewMonth,
        d: dayNum
      });

      calEl.appendChild(cell);
    }

    computeAndRenderStats();
  }

  function computeAndRenderStats() {
     // ===== ä¿®è­·çé‡‘ / ä¸Šç­å¤©æ•¸ï¼ˆæ¯æ¬¡ render éƒ½é‡æ–°ç®—ï¼‰=====
    const requiredWorkDays = computeMonthlyRequiredWorkDays(viewYear, viewMonth);

    const actualWorkDays = computeActualWorkDays(viewYear, viewMonth, requiredWorkDays);

    const maintenanceThreshold = computeMaintenanceBonusThreshold(requiredWorkDays);

    let weiUsed = 0;
    let psyUsedYear = 0;

    let compEarned = 0;
    let compUsed = 0;

    const keys = Object.keys(store);
    for (const k of keys) {
      const e = store[k];
      if (!e || !e.status) continue;
      const {y,m,d} = parseKey(k);

      if (e.status === STATUS.WEI) weiUsed++;
      if (y === viewYear && e.status === STATUS.PSY) psyUsedYear++;
      if (e.status === STATUS.COMP) compUsed++;

      if (isRedDay(y,m,d) && e.status === STATUS.WORK) compEarned++;
    }

    const weiLeft = WEI_TOTAL - weiUsed;
    weiBig.textContent = `${Math.max(weiLeft,0)} å¤©å‰©é¤˜`;
    weiUsedPill.textContent = `å·²ç”¨ï¼š${weiUsed} å¤©`;
    weiLeftPill.textContent = `å‰©é¤˜ï¼š${weiLeft} å¤©`;
    weiLeftPill.className = "pill " + (weiLeft>=0 ? "ok" : "bad");

    const psyLeft = PSY_TOTAL_PER_YEAR - psyUsedYear;
    psyBig.textContent = `${Math.max(psyLeft,0)} å¤©ï¼ˆ${viewYear} å¹´å‰©é¤˜ï¼‰`;
    psyUsedPill.textContent = `å·²ç”¨ï¼š${psyUsedYear} å¤©`;
    psyLeftPill.textContent = `å‰©é¤˜ï¼š${psyLeft} å¤©`;
    psyLeftPill.className = "pill " + (psyLeft>=0 ? "ok" : "bad");

    const owe = compEarned - compUsed;
    compBig.textContent = `${owe} å¤©`;
    compEarnPill.textContent = `ç´¯ç©é¡åº¦ï¼š${compEarned} å¤©`;
    compUsedPill.textContent = `å·²ç”¨ï¼š${compUsed} å¤©`;
    compOwePill.textContent = `å°šæœ‰ï¼š${owe} å¤©`;
    compOwePill.className = "pill " + (owe>=0 ? "ok" : "warn");
    
    requiredWorkPill.textContent = `æ‡‰ä¸Šç­ï¼š${requiredWorkDays} å¤©`;

    actualWorkPill.textContent = `å¯¦éš›ä¸Šç­ï¼š${actualWorkDays} å¤©`;

    thresholdWorkPill.textContent = `é–€æª»ï¼š${maintenanceThreshold} å¤©`;

  workDayBig.textContent =
    actualWorkDays >= maintenanceThreshold ? "âœ… é”æ¨™" : "âŒ æœªé”æ¨™";

    // // TEST: working days calculation
    // console.log("ğŸ“Š æ¯æœˆæ‡‰ä¸Šç­å¤©æ•¸:", requiredWorkDays);
    // console.log("ğŸ“Š å¯¦éš›ä¸Šç­å¤©æ•¸:", actualWorkDays);
    // console.log("ğŸ“Š ä¿®è­·çé‡‘é–€æª»:", maintenanceThreshold);

  }

  // ====== Modal ======
  let editing = null;
  function openEditModal(y,m,d) {
    editing = {y,m,d};
    const k = keyOf(y,m,d);
    const red = isRedDay(y,m,d);
    const st = getDayStatus(y,m,d);
    const note = getDayNote(y,m,d);
    const label = redDayLabel(y,m,d);

    mTitle.textContent = `ç·¨è¼¯ï¼š${k}`;
    mIsRed.textContent = red ? `æ˜¯ï¼ˆ${label || "æ”¿åºœè¡Œäº‹æ›†"}ï¼‰` : "å¦";

    statusSel.value = st;
    noteInp.value = note;

    const hints = [];
    if (red) {
      hints.push("é€™å¤©æ˜¯è¦‹ç´…ä¼‘ï¼šè‹¥é¸ã€Œä¾‹å‡ã€â†’ è¨ˆå…¥ä¾‹å‡ã€‚");
      hints.push("è‹¥é¸ã€Œä¸Šç­ã€â†’ è¦–ç‚ºç´…å­—å‡ºå‹¤ï¼Œè£œå‡é¡åº¦ +1ã€‚");
      hints.push("è‹¥é¸ã€Œæ…°ä¼‘/è£œå‡/å¿ƒç†èª¿é©å‡ã€â†’ ä»£è¡¨ä½ ç”¨è©²å‡åˆ¥ä¼‘ï¼Œä¸è¦–ç‚ºä¾‹å‡ã€‚");
    } else {
      hints.push("é€™å¤©ä¸æ˜¯è¦‹ç´…ä¼‘ï¼šé€šå¸¸ä¸å½±éŸ¿è£œå‡é¡åº¦ã€‚");
    }
    mHint.textContent = hints.join(" ");

    modalBack.style.display = "flex";
  }

  function closeEditModal() {
    modalBack.style.display = "none";
    editing = null;
  }

  closeModal.addEventListener("click", closeEditModal);
  modalBack.addEventListener("click", (e)=>{ if (e.target===modalBack) closeEditModal(); });

  clearDayBtn.addEventListener("click", ()=>{
    if (!editing) return;
    const k = keyOf(editing.y, editing.m, editing.d);
    delete store[k];
    saveAll(store);
    closeEditModal();
    render();
  });

  saveDayBtn.addEventListener("click", ()=>{
    if (!editing) return;
    const k = keyOf(editing.y, editing.m, editing.d);
    store[k] = { status: statusSel.value, note: noteInp.value.trim() };
    saveAll(store);
    closeEditModal();
    render();
  });

  // ====== Navigation ======
  prevBtn.addEventListener("click", ()=>{
    viewMonth--;
    if (viewMonth<=0){ viewMonth=12; viewYear--; }
    render();
  });
  nextBtn.addEventListener("click", ()=>{
    viewMonth++;
    if (viewMonth>=13){ viewMonth=1; viewYear++; }
    render();
  });
  todayBtn.addEventListener("click", ()=>{
    viewYear = now.getFullYear();
    viewMonth = now.getMonth()+1;
    render();
  });
  monthSel.addEventListener("change", ()=>{
    viewMonth = Number(monthSel.value);
    render();
  });
  yearInp.addEventListener("change", ()=>{
    const v = Number(yearInp.value);
    if (!Number.isFinite(v)) return;
    viewYear = Math.max(1970, Math.min(2100, v));
    render();
  });

  // ====== Reset actions ======
  resetMonthBtn.addEventListener("click", ()=>{
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ­¤æœˆæ‰€æœ‰è¨­å®šï¼Ÿï¼ˆåªå½±éŸ¿ç›®å‰æª¢è¦–æœˆä»½ï¼‰")) return;
    const y=viewYear, m=viewMonth;
    for (let d=1; d<=31; d++) {
      const k=keyOf(y,m,d);
      if (store[k]) delete store[k];
    }
    saveAll(store);
    render();
  });

  resetAllBtn.addEventListener("click", ()=>{
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ç´€éŒ„ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")) return;
    store = {};
    saveAll(store);
    render();
  });

  // ====== Import/Export shift records ======
  exportBtn.addEventListener("click", ()=>{
    jsonBox.value = JSON.stringify(store, null, 2);
    jsonBox.focus();
    jsonBox.select();
  });

  importBtn.addEventListener("click", ()=>{
    try{
      const obj = JSON.parse(jsonBox.value);
      if (!obj || typeof obj !== "object") throw new Error("JSON ä¸æ˜¯ç‰©ä»¶");
      for (const [k,v] of Object.entries(obj)) {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) throw new Error("æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼š" + k);
        if (!v || typeof v !== "object") throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼š" + k);
        if (v.status && !STATUS_META[v.status]) throw new Error("æœªçŸ¥ç‹€æ…‹ï¼š" + v.status + " @ " + k);
        if (v.note && typeof v.note !== "string") throw new Error("note å¿…é ˆæ˜¯å­—ä¸²ï¼š" + k);
      }
      store = obj;
      saveAll(store);
      alert("åŒ¯å…¥æˆåŠŸ");
      render();
    } catch(err) {
      alert("åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
    }
  });

  // è£ç½®æ—‹è½‰
  window.addEventListener("orientationchange", () => {
    syncUIMode();
  });

  // Resize
  let resizeTimer = null;

  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      syncUIMode();
    }, 150);
  });


  // ====== Boot ======
  (async ()=>{
    initTheme();
    await loadGovCalendar();
    syncUIMode();
    render();
  })();
})();
</script>
</body>
</html>
